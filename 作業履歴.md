# 作業履歴

## 2026-01-10: Secret Manager 設定とメール機能実装

### 実施内容

#### 1. Cloud Secret Manager 設定
- Cloud Secret Manager API を有効化
- 以下のシークレットを登録:
  - `smtp-server`: sv1231.xserver.jp
  - `smtp-port`: 465
  - `smtp-user`: info@s-style.ne.jp
  - `smtp-password`: （登録済み）
  - `imap-server`: sv1231.xserver.jp
  - `imap-port`: 993
  - `imap-user`: info@s-style.ne.jp

#### 2. GCS バケット作成
- バケット名: `s-style-hrd-blobs`
- リージョン: asia-northeast1

#### 3. app.yaml 環境変数追加
```yaml
env_variables:
  SECRET_KEY: 'aa696007dec3493033c2537ac73887fcec8af583c97ffb8c23b182afe3ea2cbb'
  GCP_PROJECT: 's-style-hrd'
  BASE_URL: 'https://s-style-hrd.appspot.com'
  GCS_BUCKET_NAME: 's-style-hrd-blobs'
```

#### 4. コード修正（Secret Manager 対応）

| ファイル | 変更内容 |
|---------|---------|
| `requirements.txt` | `google-cloud-secret-manager==2.18.0` 追加 |
| `application/secret_manager.py` | **新規作成** - シークレット取得ユーティリティ |
| `application/messageManager.py` | Secret Manager から SMTP 設定取得、SSL/TLS 接続 |
| `application/email_receiver.py` | Secret Manager から IMAP 設定取得 |
| `application/sendmsg.py` | Secret Manager から SMTP 設定取得、SSL/TLS 接続 |

#### 5. デプロイ
- バージョン: `test-20260110-secret`
- サービス: `test-service`

#### 6. テスト結果
- SMTP メール送信テスト: **成功**
- 送信先: warao.shikyo@gmail.com
- 受信確認済み

### 本番システムへの影響
- 変更は `migration-src/` 内のみ
- 本番の Python 2.7 システム（`src/`）は変更なし
- dispatch.yaml により `/test/*` のみが test-service にルーティング

---

## 2026-01-10: TODO-03 メール機能移行（追加作業）

### 実施内容

#### 1. memberSearchandMail Flask移行（移行漏れ対応）

初期移行時に欠落していた2クラスを追加:

| クラス | 説明 |
|--------|------|
| `mailsendback` | メール送信バックエンドタスク |
| `memberSearchandMailback` | メンバー検索バックエンドタスク |

**原因**: 初期Flask移行時に `memberSearchandMail` クラスのみ移行され、バックエンドタスク用クラスが移行漏れしていた（元ファイル449行 → 移行後262行）

#### 2. main.py ルート追加

| ルート | ハンドラー |
|--------|-----------|
| `/test/membersearch` | memberSearchandMail |
| `/test/membersearchback` | memberSearchandMailback |
| `/test/tasks/mailinglistsend` | memberSearchandMailback |
| `/test/mailsendback` | mailsendback |
| `/test/tasks/mailsendback` | mailsendback |
| `/test/tasks/check-incoming-mail` | mail_handler_route（IMAP受信） |

#### 3. デプロイ
- バージョン: `test-20260110-mail`
- サービス: `test-service`

### TODO-03 完了状況

| カテゴリ | 状態 |
|---------|------|
| Secret Manager 設定 | ✅ 完了 |
| SMTP送信（コード実装） | ✅ 完了 |
| IMAP受信（コード実装） | ✅ 完了 |
| memberSearchandMail Flask移行 | ✅ 完了 |
| ルート登録 | ✅ 完了 |
| GAE上テスト | ❌ 未実施 |

### 次のタスク
- TODO-02: Blobstore → GCS 移行
- TODO-04: 本番移行対応

---

## 2026-01-11: TODO-02 Blobstore → GCS 移行（データ移行ツール作成・実行）

### 実施内容

#### 1. Blobデータ調査

##### データ件数確認
| 区分 | 件数 | 割合 |
|------|------|------|
| 全体 | 29,876 件 | 100% |
| 2023/01/01 より前 | 29,610 件 | 99.1% |
| 2023/01/01 以降 | 266 件 | 0.9% |

##### blobKey形式確認
| 形式 | 件数 |
|------|------|
| AMIfv...（レガシーBlobstore） | 29,837 件 |
| 空 | 39 件 |

#### 2. 移行ツール作成

| ツール | 用途 | 安全性 |
|--------|------|--------|
| `check_blob_count.py` | 件数確認 | 読み取り専用 |
| `check_blobkey_format.py` | blobKey形式分析 | 読み取り専用 |
| `check_file_extensions.py` | 拡張子統計 | 読み取り専用 |
| `download_and_upload_blob.py` | HTTP経由コピー（**推奨**） | Datastore変更なし |
| `copy_blob_to_gcs.py` | 内部GCS直接コピー | 動作せず（パス不明） |
| `migrate_blob_to_gcs.py` | 本番移行用 | Datastore更新あり |

#### 3. 移行方式の検討

##### 試行1: Blobstore内部GCS直接アクセス
- `gs://s-style-hrd.appspot.com/encoded_gs_key/...` → ファイルなし
- **結果**: 失敗（内部パス形式が不明）

##### 試行2: HTTP経由ダウンロード＆アップロード
- Python 2.7アプリの `/serve/{blobKey}` エンドポイント使用
- **結果**: 成功

#### 4. 2023年以降データのGCSコピー実行

##### 設定
- リクエスト間隔: 1秒（レート制限対策）
- 所要時間: 約10分

##### 結果
| 項目 | 結果 |
|------|------|
| 処理対象 | 266件 |
| 成功 | 264件 |
| スキップ | 2件（blobKeyなし） |
| エラー | 0件 |
| **合計サイズ** | **155.4 MB** |
| 平均サイズ | 602.8 KB |
| 最大サイズ | 2.9 MB |

##### コピー先
```
gs://s-style-hrd-blobs/{CorpOrg_key}/{Branch_Key}/{bkID}/{blobNo}.{ext}
```

#### 5. 全体サイズ推定（実測ベース）

| 区分 | 件数 | サイズ |
|------|------|--------|
| 2023/01/01 以降 | 266件 | 155.4 MB（実測） |
| 2023/01/01 より前 | 29,610件 | 約17.4 GB（推定） |
| **全体** | 29,876件 | **約17.5 GB** |

#### 6. ドキュメント作成

| ファイル | 内容 |
|---------|------|
| `migration-src/tools/README.md` | 移行ツール完全ドキュメント |
| `NEXT-SESSION-PROMPT.md` | 進捗状況更新 |

### 技術的知見

1. **Blobstore内部GCSへの直接アクセス不可**
   - `AMIfv...` 形式のblobKeyからGCSパスを特定できなかった
   - HTTP経由（`/serve/` エンドポイント）でのみアクセス可能

2. **ファイルサイズの傾向**
   - dry-runサンプル（10件）: 平均151.4 KB
   - 実測全体（266件）: 平均602.8 KB
   - 写真ファイルは1〜3MBと大きい

3. **レート制限対策**
   - 1秒間隔でリクエスト
   - エラー0件、ブロックなし

### 残り作業

| 項目 | 値 |
|------|------|
| 対象 | 2023年より前のデータ |
| 件数 | 29,610件 |
| 推定サイズ | 約17.4 GB |
| 推定所要時間 | 15〜25時間（HTTP経由） |

### 高速化オプション
Python 2.7側に移行ハンドラを追加すれば、GAE内部で処理可能（ネットワーク往復不要）

### 注意事項
- 現時点でDatastoreは**未更新**（blobKeyは元のまま）
- GCSへのファイルコピーのみ完了
- 本番移行時に `migrate_blob_to_gcs.py` でDatastore更新が必要
