#!/usr/local/bin/python
# -*- coding: utf-8 -*-
#
"""My Contact List, a simple address book application

Author    : OKAZAKI Hiroki (okaz@teshigoto.net, https://www.teshigoto.net/)
Version   : $Id: view.py,v 1.3 2009/02/04 06:27:21 okaz Exp $
Copyright : Copyright (c) 2009 OKAZAKI Hiroki
License   : Python
"""

import os
import re
import gettext

from google.appengine.ext import webapp
from google.appengine.ext.webapp import template

class View:
    default_lang = 'en'
    supported_lang = ['ja', 'en']

    def __init__(self, handler):
        #
        # initialize for gettext
        #
        self.handler = handler
        self.lang = {}

        locale_path = os.path.dirname(__file__) + '/../locale'
        #locale_path = os.path.dirname(__file__) + '/locale'


        for langname in self.supported_lang:
            self.lang[langname] = gettext.translation('resource', 
                                                      locale_path, 
                                                      languages=[langname])

        accept_lang = os.environ['HTTP_ACCEPT_LANGUAGE']
        self.default_lang = re.compile('^.{2}').match(accept_lang).group()

    def render(self, tmpl_fn, tmpl_val):
        #
        # HTML rendering
        #
        self._set_msg(tmpl_val)
        path = os.path.dirname(__file__) + '/../templates/' + tmpl_fn + '.html'
        self.handler.out.write(template.render(path, tmpl_val))

    def set_default_lang(self, new_lang):
        #
        # exchange default language
        #
        self.default_lang = new_lang

    def _set_msg(self, dict):
        #
        # set message resource with gettexxt
        #
        accept_lang = self.default_lang
        if not accept_lang:
            accept_lang = 'en'
        if not (accept_lang in self.supported_lang):
            accept_lang = 'en'

        self.lang[accept_lang].install()
        _ = self.lang[accept_lang].gettext

        #
        # static messages list
        #
        msg = {
            #
            # login.html
            #
            'login_welcome' : _('login_welcome'),
            'login_id' : _('login_id'),
            'login_pwd' : _('login_pwd'),
            'login_submit' : _('login_submit'),
            'new_regist' : _('new_regist'),
            'resign' : _('resign'),

            #
            # regist.html
            #
            'regist_step' : _('regist_step'),
            'new_login_id' : _('new_login_id'),
            'new_login_pwd' : _('new_login_pwd'),
            'new_user_email' : _('new_user_email'),
            'new_regist' : _('new_regist'),
            'return_top' : _('return_top'),

            #
            # resign.html
            #
            'resign_step' : _('resign_step'),
            'resign_login_id' : _('resign_login_id'),
            'resign_login_pwd' : _('resign_login_pwd'),
            'resign_user_email' : _('resign_user_email'),
            'resign' : _('resign'),

            #
            # proc.html
            #
            'lang_en' : _('lang_en'),
            'lang_ja' : _('lang_ja'),
            'auth_success' : _('auth_success'),
            'logout' : _('logout'),
            }

        #
        # set static messages to buffer
        #
        for i, v in msg.iteritems():
            if not i in dict:
                dict[i] = v
            else:
                print("duplicated key %s in %s " % (i, __file__))

        #
        # error and completed message setting with gettext translation
        #
        if 'error_msg' in dict and dict['error_msg']:
            dict['error_msg'] = _(dict['error_msg'])

        if 'completed_msg' in dict and dict['completed_msg']:
            dict['completed_msg'] = _(dict['completed_msg'])

        #
        # dynamic messages list for gettext converter
        #
        error_msg_list = (
            "_('not_found')",
            "_('short_pwd')",
            "_('invalid_email_address')",
            "_('duplicated_id')",
            "_('illegal_key')",
            "_('login_id_not_found')",
            )

        completed_msg_list = (
            "_('regist_confirm_completed')",
            "_('resign_completed')",
            "_('login_id_not_found')",
            )
